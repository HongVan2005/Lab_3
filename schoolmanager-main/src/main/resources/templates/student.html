<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Sinh Vi√™n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .list-group-item {
            border: 1px solid #dee2e6;
            cursor: pointer;
            padding: 10px 12px;
        }
        .list-group-item:hover {
            background-color: #e9ecef;
            border-color: #0d6efd;
        }
        #searchInput {
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="mb-4 text-primary">üìö Qu·∫£n L√Ω Sinh Vi√™n</h1>
            
            <!-- Message -->
            <div id="message" class="alert alert-info d-none" role="alert"></div>

            <!-- Form Th√™m/S·ª≠a -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Th√¥ng Tin Sinh Vi√™n</h5>
                </div>
                <div class="card-body">
                    <input type="hidden" id="studentId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">H·ªç T√™n</label>
                            <input type="text" class="form-control" id="name" placeholder="Nh·∫≠p h·ªç t√™n">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="Nh·∫≠p email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tu·ªïi</label>
                            <input type="number" class="form-control" id="age" placeholder="Nh·∫≠p tu·ªïi" min="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gi·ªõi T√≠nh</label>
                            <select class="form-select" id="gender">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                                <option value="Kh√°c">Kh√°c</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cho ph√©p x√≥a?</label>
                            <select class="form-select" id="canDelete">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="true" selected>‚úÖ ƒê∆∞·ª£c x√≥a</option>
                                <option value="false">‚ùå Kh√¥ng ƒë∆∞·ª£c x√≥a</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-success" onclick="addStudent()">‚ûï Th√™m</button>
                        <button class="btn btn-warning" onclick="updateStudent()">‚úèÔ∏è C·∫≠p Nh·∫≠t</button>
                        <button class="btn btn-secondary" onclick="clearForm()">üîÑ X√≥a Form</button>
                    </div>
                </div>
            </div>

            <!-- T√¨m Ki·∫øm Sinh Vi√™n (Dropdown) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üîç T√¨m Ki·∫øm & Ch·ªçn Sinh Vi√™n</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">T√¨m ki·∫øm theo:</label>
                            <select class="form-select" id="searchType">
                                <option value="name" selected>üìù T√™n sinh vi√™n</option>
                                <option value="id">üÜî ID</option>
                                <option value="age">üéÇ Tu·ªïi</option>
                                <option value="email">üìß Email</option>
                                <option value="gender">üë• Gi·ªõi t√≠nh</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Nh·∫≠p t·ª´ kh√≥a:</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="searchInput" placeholder="Nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm...">
                                <div class="list-group position-absolute w-100" id="searchResults" style="display: none; z-index: 1000;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B·∫£ng Sinh Vi√™n -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Danh S√°ch Sinh Vi√™n</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">ID</th>
                                <th>H·ªç T√™n</th>
                                <th>Email</th>
                                <th class="text-center">Tu·ªïi</th>
                                <th class="text-center">Gi·ªõi T√≠nh</th>
                                <th class="text-center">X√≥a?</th>
                                <th class="text-center">H√†nh ƒê·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="studentTable">
                            <tr>
                                <td colspan="6" class="text-center text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "http://localhost:8080/students";

    function loadStudents() {
        hideMessage();
        fetch(API)
            .then(res => res.json())
            .then(renderTable)
            .catch(showError);
    }

    function renderTable(data) {
        const table = document.getElementById("studentTable");
        table.innerHTML = "";

        if (!data || data.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Kh√¥ng c√≥ d·ªØ li·ªáu
                    </td>
                </tr>`;
            return;
        }

        data.forEach(s => {
            table.innerHTML += `
                <tr>
                    <td class="text-center">${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td class="text-center">${s.age}</td>
                    <td class="text-center">${s.gender}</td>
                    <td class="text-center">${s.canDelete ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</td>
                    <td class="text-center">
                        <button class="btn btn-warning btn-sm"
                                onclick="editStudent(${s.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" ${!s.canDelete ? 'disabled' : ''}
                                onclick="deleteStudent(${s.id})">üóë</button>
                    </td>
                </tr>`;
        });
    }

    function addStudent() {
        const student = getFormData();
        if (!student) return;

        fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(student)
        })
        .then(res => res.json())
        .then(data => {
            showMessage(`‚úÖ Th√™m sinh vi√™n ${data.name} th√†nh c√¥ng!`);
            loadStudents();
            clearForm();
        })
        .catch(showError);
    }

    function updateStudent() {
        const id = document.getElementById("studentId").value;
        if (!id) {
            showMessage("‚ö†Ô∏è Ch·ªçn sinh vi√™n c·∫ßn c·∫≠p nh·∫≠t");
            return;
        }

        const student = getFormData();
        if (!student) return;

        fetch(`${API}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(student)
        })
        .then(res => res.json())
        .then(data => {
            showMessage(`‚úÖ C·∫≠p nh·∫≠t sinh vi√™n ${data.name} th√†nh c√¥ng!`);
            loadStudents();
            clearForm();
        })
        .catch(showError);
    }

    function deleteStudent(id) {
        // Ki·ªÉm tra xem sinh vi√™n c√≥ ƒë∆∞·ª£c ph√©p x√≥a kh√¥ng
        const row = document.querySelector(`button[onclick="deleteStudent(${id})"]`).closest('tr');
        const studentName = row.children[1].textContent.trim();
        const canDeleteCell = row.children[5].textContent.trim();
        
        if (canDeleteCell.includes('Kh√¥ng')) {
            showMessage("‚ùå Sinh vi√™n n√†y kh√¥ng ƒë∆∞·ª£c ph√©p x√≥a");
            return;
        }

        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?")) return;

        fetch(`${API}/${id}`, { method: "DELETE" })
            .then(() => {
                showMessage(`‚úÖ X√≥a sinh vi√™n ${studentName} th√†nh c√¥ng!`);
                loadStudents();
            })
            .catch(showError);
    }

    function editStudent(id) {
        fetch(`${API}/${id}`)
            .then(res => res.json())
            .then(s => {
                document.getElementById("studentId").value = s.id;
                document.getElementById("name").value = s.name;
                document.getElementById("email").value = s.email;
                document.getElementById("age").value = s.age;
                document.getElementById("gender").value = s.gender;
            })
            .catch(showError);
    }

    // üîç T√¨m ki·∫øm v·ªõi dropdown
    document.getElementById("searchInput").addEventListener("input", function() {
        const query = this.value.trim();
        const searchType = document.getElementById("searchType").value;
        const resultsDiv = document.getElementById("searchResults");

        if (!query) {
            resultsDiv.style.display = "none";
            return;
        }

        let url = `${API}`;
        
        // X√¢y d·ª±ng URL t√¨m ki·∫øm d·ª±a tr√™n lo·∫°i t√¨m ki·∫øm
        if (searchType === "name") {
            url += `/search?name=${encodeURIComponent(query)}`;
        } else if (searchType === "email") {
            url += `/search?name=${encodeURIComponent(query)}`;
        } else if (searchType === "id") {
            // T√¨m theo ID
            if (!isNaN(query)) {
                fetch(`${API}/${query}`)
                    .then(res => res.ok ? res.json() : Promise.reject())
                    .then(student => {
                        resultsDiv.innerHTML = "";
                        const item = document.createElement("button");
                        item.className = "list-group-item list-group-item-action";
                        item.type = "button";
                        item.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <strong>${student.name}</strong>
                                <span class="text-muted text-sm">#${student.id}</span>
                            </div>
                            <small class="text-muted">${student.email} | Tu·ªïi: ${student.age} | Gi·ªõi t√≠nh: ${student.gender}</small>
                        `;
                        item.onclick = () => selectStudent(student);
                        resultsDiv.appendChild(item);
                        resultsDiv.style.display = "block";
                    })
                    .catch(() => {
                        resultsDiv.innerHTML = '<div class="list-group-item">Kh√¥ng t√¨m th·∫•y ID sinh vi√™n n√†y</div>';
                        resultsDiv.style.display = "block";
                    });
                return;
            }
        } else if (searchType === "age") {
            // T√¨m theo tu·ªïi
            if (!isNaN(query)) {
                fetch(`${API}`)
                    .then(res => res.json())
                    .then(data => {
                        const filtered = data.filter(s => s.age == query);
                        displaySearchResults(filtered, resultsDiv);
                    })
                    .catch(showError);
                return;
            }
        } else if (searchType === "gender") {
            // T√¨m theo gi·ªõi t√≠nh
            fetch(`${API}`)
                .then(res => res.json())
                .then(data => {
                    const filtered = data.filter(s => s.gender.toLowerCase().includes(query.toLowerCase()));
                    displaySearchResults(filtered, resultsDiv);
                })
                .catch(showError);
            return;
        }

        // T√¨m ki·∫øm theo t√™n ho·∫∑c email
        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (searchType === "email") {
                    data = data.filter(s => s.email.toLowerCase().includes(query.toLowerCase()));
                }
                displaySearchResults(data, resultsDiv);
            })
            .catch(showError);
    });

    function displaySearchResults(data, resultsDiv) {
        resultsDiv.innerHTML = "";
        if (data.length === 0) {
            resultsDiv.innerHTML = '<div class="list-group-item">Kh√¥ng t√¨m th·∫•y sinh vi√™n</div>';
            resultsDiv.style.display = "block";
            return;
        }

        data.forEach(student => {
            const item = document.createElement("button");
            item.className = "list-group-item list-group-item-action";
            item.type = "button";
            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${student.name}</strong>
                    <span class="text-muted text-sm">#${student.id}</span>
                </div>
                <small class="text-muted">${student.email} | Tu·ªïi: ${student.age} | Gi·ªõi t√≠nh: ${student.gender}</small>
            `;
            item.onclick = () => selectStudent(student);
            resultsDiv.appendChild(item);
        });
        resultsDiv.style.display = "block";
    }

    function selectStudent(student) {
        document.getElementById("studentId").value = student.id;
        document.getElementById("name").value = student.name;
        document.getElementById("email").value = student.email;
        document.getElementById("age").value = student.age;
        document.getElementById("gender").value = student.gender;
        document.getElementById("canDelete").value = student.canDelete ? "true" : "false";
        document.getElementById("searchInput").value = "";
        document.getElementById("searchResults").style.display = "none";
        showMessage(`‚úÖ ƒê√£ ch·ªçn sinh vi√™n: ${student.name}`);
    }

    // ·∫®n dropdown khi click ngo√†i
    document.addEventListener("click", function(e) {
        if (e.target.id !== "searchInput" && e.target.id !== "searchResults") {
            document.getElementById("searchResults").style.display = "none";
        }
    });

    function getFormData() {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const age = document.getElementById("age").value;
        const gender = document.getElementById("gender").value;
        const canDelete = document.getElementById("canDelete").value === "true";

        if (!name || !email || !age || !gender) {
            showMessage("‚ö†Ô∏è Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
            return null;
        }

        if (age <= 0) {
            showMessage("‚ö†Ô∏è Tu·ªïi ph·∫£i > 0");
            return null;
        }

        return { name, email, age, gender, canDelete };
    }

    function clearForm() {
        ["studentId","name","email","age","gender","canDelete"]
            .forEach(id => {
                if (id === "canDelete") {
                    document.getElementById(id).value = "true";
                } else {
                    document.getElementById(id).value = "";
                }
            });
    }

    function showMessage(text) {
        const msg = document.getElementById("message");
        msg.innerText = text;
        msg.classList.remove("d-none");
    }

    function hideMessage() {
        document.getElementById("message").classList.add("d-none");
    }

    function showError() {
        showMessage("‚ùå L·ªói k·∫øt n·ªëi server");
    }

    loadStudents();
</script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>